---
title: 分库分表
categories: 
- 分布式
---

**什么是分库分表**

**分库**：就是一个数据库分成多个数据库，部署到不同机器。

<img src="https://img-blog.csdnimg.cn/cdbcfa1e07034ea084f17d591b281595.png" alt="img" style="zoom:25%;" />

**分表**：就是一个数据库表分成多个表。

<img src="https://img-blog.csdnimg.cn/b43e9d41ba7f4a36a3b3d706f7b2be98.png" alt="img" style="zoom:25%;" />

**什么时候要分库分表**

参考阿里巴巴的《Java 开发手册》中数据库部分的建表规约：

- 单表行数超过 500 万行或者单表容量超过 2GB，才推荐进行分库分表。

**如何分库分表**

> 垂直切分

垂直分表是针对业务上的字段比较多的大表进行的，一般是把业务宽表中比较独立的字段，或者不常用的字段拆分到单独的数据表中。

> 水平切分

水平拆分是把相同的表结构分散到不同的数据库和不同的数据表中，避免访问集中的单个数据库或者单张数据表。

**分库分表后引入的问题**

> 分布式事务问题

对业务进行分库之后，同一个操作会分散到多个数据库中，涉及跨库执行 SQL 语句，也就出现了分布式事务问题。

> 跨库关联查询问题

用户在查询订单时，我们往往需要通过表连接获取到商品信息，而商品信息表可能在另外一个库中，这就涉及到了跨库JOIN查询。

通常，我们会冗余表或冗余字段来优化跨库JOIN查询。对于一些基础表，例如商品信息表，我们可以在每一个订单分库中复制一张基础表，避免跨库JOIN查询。而对于一两个字段的查询，我们也可以将少量字段冗余在表中，从而避免JOIN查询，也就避免了跨库JOIN查询。

> 跨库跨表的合并和排序问题

> 跨节点分页查询问题

我们知道，当用户在订单列表中查询所有订单时，可以通过用户ID的Hash值来快速查询到订单信息，而运营人员在后台对订单表进行查询时，则是通过订单付款时间来进行查询的，这些数据都分布在不同的库以及表中，此时就存在一个跨节点分页查询的问题了。

通常一些中间件是通过在每个表中先查询出一定的数据，然后在缓存中排序后，获取到对应的分页数据。这种方式在越往后面的查询，就越消耗性能。

通常我们建议使用两套数据来解决跨节点分页查询问题，一套是基于分库分表的用户单条或多条查询数据，一套则是基于Elasticsearch、Solr存储的订单数据，主要用于运营人员根据其它字段进行分页查询。

为了不影响提交订单的业务性能，我们一般使用异步消息来实现Elasticsearch、Solr订单数据的新增和修改。

**分库分表中间件实现**

这里比较推荐 [Apache ShardingSphere](https://shardingsphere.apache.org/document/current/cn/overview/)

**分表策略**

> Range

首先第一种是按照范围划分，比如我们可以将某张表的创建时间按照日期划分存为月表；

也可以将某张表的主键按照范围划分，比如 `1~10000`在一张表，`10001~20000`在一张表，以此类推。

这样的分表适合需要对数据做归档处理，比如系统默认只提供近三个月历史数据的查询功能，只需要把三月之前的数据单独移走备份保存即可）。

**弊端：**

- 好处是自带水平扩展，不需要过多干预
- 缺点是可能会出现数据不均匀的情况（比如某个月请求暴增）

> Hash

通过哈希取模的方式进行路由，优点是数据拆分比较均匀，但缺点是不利于后面的扩容。

> Range+Hash

比如我们一开始采用的是 Hash 分表，但是数据增长巨大，导致每张分表数据很快达到瓶颈，这样就不得不再做扩容，比如由 64 张表扩容到 256 张。

但扩容时想要做到不停机迁移数据非常困难。

所以我们是否可以在 `Hash` 分表的基础上再分为月表，借助于 `Range` 自身的扩展性就不用考虑后续数据迁移的事情了。