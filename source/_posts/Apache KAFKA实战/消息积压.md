---
title: 消息积压
categories: 
- Apache KAFKA实战
---

**消息体过大**

kafka从producer发送消息到broker需要一次网络IO，broker写数据到磁盘需要一次磁盘IO（写操作），consumer从broker获取消息先经过一次磁盘IO（读操作），再经过一次网络IO。

<img src="https://img-blog.csdnimg.cn/0f44319ed20c4c7fa2c7d741219a05b2.png" style="zoom:25%;" />

一次简单的消息从生产到消费过程，需要经过2次网络IO和2次磁盘IO。

* 如果消息体过大，势必会增加IO的耗时，进而影响kafka生产和消费的速度。消费者速度太慢的结果，就会出现消息积压情况。

除了上面的问题之外，消息体过大，还会浪费服务器的磁盘空间，稍不注意，可能会出现磁盘空间不足的情况。

此时，我们已经到了需要优化消息体过大问题的时候。

**路由规则不合理**

在使用Kafka Producer消息时，可以为消息指定key，但是要求key要均匀，否则会出现Kafka分区间数据不均衡。

<img src="https://img-blog.csdnimg.cn/5fc9126e89e946f690c4d525a514048d.png" style="zoom:33%;" />

**消费者消费时间过长**

如果生产端出现消息发送增多，消费端每次都拉取了 500（`max.poll.records`） 条消息进行消费，这时就很容易导致消费时间过长，如果超过了 `max.poll.interval.ms` 所设置的时间，就会被消费组所在的 coordinator 剔除掉，从而导致重平衡。

Kafka 重平衡过程中是不能消费的，会导致消费组处于类似 stop the world 的状态下，重平衡过程中也不能提交位移，这会导致消息重复消费从而使得消费组的消费速度下降，导致消息堆积。