---
title: 元空间
categories: 
- JVM相关
---

**元空间介绍**

* 在JDK1.7之前，HotSpot 虚拟机把方法区当成永久代来进行垃圾回收。

* 从 JDK 1.8 开始，移除永久代，并把方法区移至元空间，它位于本地内存中，而不是虚拟机内存中。

**它和永久代有什么不同？**

存储位置不同：永久代在物理上是堆的一部分，和新生代、老年代的地址是连续的，而元空间属于本地内存。

存储内容不同：在原来的永久代划分中，永久代用来存放类的元数据信息、静态变量以及常量池等。

现在类的元信息存储在元空间中，静态变量和常量池等并入堆中，相当于原来的永久代中的数据，被元空间和堆内存给瓜分了。

<img src="https://img-blog.csdnimg.cn/6458f5a114854e12ba39ff248a55e965.png" style="zoom:25%;" />

**为什么要废弃永久代，引入元空间？**

在原来的永久代划分中，永久代需要存放类的元数据、静态变量和常量等。

它的大小不容易确定，因为这其中有很多影响因素，比如类的总数，常量池的大小和方法数量等，`-XX:MaxPermSize` 指定太小很容易造成永久代内存溢出。

移除永久代是为融合HotSpot VM与 JRockit VM而做出的努力，因为JRockit没有永久代，不需要配置永久代。

永久代会为GC带来不必要的复杂度，并且回收效率偏低。

**废除永久代的好处**

由于类的元数据分配在本地内存中，元空间的最大可分配空间就是系统可用内存空间。不会遇到永久代存在时的内存溢出错误。

将运行时常量池从PermGen分离出来，与类的元数据分开，提升类元数据的独立性。

将元数据从PermGen剥离出来到Metaspace，可以提升对元数据的管理同时提升GC效率。

**Metaspace相关参数**

* -XX:MetaspaceSize，初始空间大小，达到该值就会触发垃圾收集进行类型卸载，同时GC会对该值进行调整：如果释放了大量的空间，就适当降低该值；如果释放了很少的空间，那么在不超过MaxMetaspaceSize时，适当提高该值。

* -XX:MaxMetaspaceSize，最大空间，默认是没有限制的。如果没有使用该参数来设置类的元数据的大小，其最大可利用空间是整个系统内存的可用空间。

当Metaspace剩余空间不足，会抛出`java.lang.OutOfMemoryError: Metaspace space`

* -XX:MinMetaspaceFreeRatio，在GC之后，最小的Metaspace剩余空间容量的百分比，减少为分配空间所导致的垃圾收集。

* -XX:MaxMetaspaceFreeRatio，在GC之后，最大的Metaspace剩余空间容量的百分比，减少为释放空间所导致的垃圾收集。