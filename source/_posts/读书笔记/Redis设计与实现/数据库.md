---
title: 数据库
categories: 
- 读书笔记
- Redis设计与实现
---

Redis将所有Key进行统一管理，按照所属的库划分，放在RedisDb的字典中。

* Redis每一个库都对应一个RedisDb。

RedisDb结构的dict字典保存了该数据库中的所有键值对，也称为**键空间**。

键空间的数据结构如下：

```c
typedef struct redisDb{
    //数据库键空间，保存着数据库中的所有键值对
    dict *dict;
    ...
}
```

键空间的键就是数据库的键，每个键都是一个字符串对象，键空间的值就是字符串对象，列表对象，哈希表对象，集合对象和有序集合对象。

<img src="https://img-blog.csdnimg.cn/008f1a8125ab47459dfb940f0ef02ffd.png" style="zoom:25%;" />

当执行一些插入指令时，就是对dict中key的新增；同理，删除键后，dict中的键值对对象都会被删除。

**键过期时间相关操作**

* 通过`EXPIRE`或`PEXPIRE`，客户端可以以**秒或毫秒**为精度设置过期时间（Time To Live，TTL）。

* 通过`EXPIREAT`或`PEXPIREAT`，客户端可以设置**时间戳**作为过期时间。

使用`TTL`或`PTTL`也可查看某个键的剩余生存时间，还有多久过期。

```c
redis> SET key value
OK

redis> EXPIRE key 500
(integer) 1

redis> TTL key
(integer) 498
```

**存储过期时间**

RedisDb中有一个expires的字典数据结构保存所有键的过期时间，也称为过期字典。

过期字典的值是一个**long long**类型的整数，保存了键所指向的数据库键的过期时间（毫秒精度的Unix时间戳）。

```c
typedef struct redisDb{
    //过期字典，保存着键的过期时间
    dict *expires;
    ...
} redisDb;
```

**移除过期时间**

PERSIST命令可以**移除一个键的过期时间**，在过期字段中查找给定键，并**解除**键和值在过期字典中的关联。

**计算并返回剩余生存时间**

TTL以秒为单位返回剩余时间，PTTL以毫秒返回键的剩余时间。二者的计算都是通过计算键的过期时间与当前时间之差来实现的。

**过期键删除策略**

如果一个键过期了，那么在什么时候被删除？列举几个常见淘汰策略：

1. 定时删除：设置键的过期时间时，创建定时器，过期时，以定时器立刻执行键的删除。
2. 惰性删除：不着急删除过期键，每次获取时都会进行过期校验。
3. 定期删除：隔一段时间，程序就对数据库检查，删除过期键。

**定时删除**

定时删除策略**对内存友好**，但**对CPU不友好**。

过期键比较多时，删除会占用资源，特别是和删除当前任务无关的过期键，影响性能。

Redis定时器需要创建时间事件，时间事件底层由无需链表实现，查找复杂度为O(N)，如果需要高效处理必然要创建大量的定时器，并不现实。

**惰性删除**

惰性删除**对CPU友好**，但**对内存不友好**。

不需要把时间浪费在非相关键的删除上。当键非常多时，会导致内存泄漏，因为只有用到时才会判断，删除。

**定期删除**

定期删除是一种折衷的方式，隔一段时间执行一次，并**限制**删除操作**执行的时长和频率**减少对CPU的占用；

定期删除还能**减少庞大的过期键对内存的占用**。如何确定时长和频率是难点，过长或过少，会退变为定时删除和惰性删除。

**Redis的过期键删除策略**

Redis使用了**惰性删除和定期删除**两种策略配合，服务器可以合理地在使用CPU时间和避免内存浪费之间权衡。

- 惰性删除策略的实现

该策略由`db.c/expireIfNeeded`函数实现，如同指令过滤器，在执行读写键指令时都会调用该函数检查，如果过期则删除。

- 定期删除策略的实现

该策略由`redis.c/activeExpireCycle`函数实现，当服务器周期性调用`redis.c/serverCron`函数时，`activeExpireCycle`函数就会被调用，规定时间内，多次遍历服务器的各个数据库，从expires字典中随机检查一部分键的过期时间，并删除过期键。

**数据库通知**

Redis发布订阅功能可以让客户端获取数据库中键的变化及命令的执行情况。

* 关注某个键执行了什么命令的通知称为键空间通知。

* 关注某个命令被什么键执行的通知称为事件通知。