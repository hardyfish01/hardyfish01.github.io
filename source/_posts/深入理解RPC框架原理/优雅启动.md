---
title: 优雅启动
categories: 
- 深入理解RPC框架原理
---

**启动预热**

让刚启动的服务提供方应用不承担全部的流量，而是让它被调用的次数随着时间的移动慢慢增加，最终让流量缓和地增加到跟已经运行一段时间后的水平一样。

**那在RPC里面，我们该怎么实现这个功能呢？**

我们现在是要控制调用方发送到服务提供方的流量。调用方应用通过服务发现能够获取到服务提供方的IP地址，然后每次发送请求前，都需要通过负载均衡算法从连接池中选择一个可用连接。

那这样的话，我们是不是就可以让负载均衡在选择连接的时候，**区分一下是否是刚启动不久的应用？**

对于刚启动的应用，我们可以让它被选择到的概率特别低，但这个概率会随着时间的推移慢慢变大，从而实现一个动态增加流量的过程。

**具体实现**

首先对于调用方来说，我们要知道服务提供方启动的时间，这个怎么获取呢？

我这里给出两种方法，一种是服务提供方在启动的时候，把自己启动的时间告诉注册中心；另外一种就是注册中心收到的服务提供方的请求注册时间。这两个时间我认为都可以，不过可能你会犹豫我们该怎么确保所有机器的日期时间是一样的？

这其实不用太关心，因为整个预热过程的时间是一个粗略值，即使机器之间的日期时间存在1分钟的误差也不影响，并且在真实环境中机器都会默认开启NTP时间同步功能，来保证所有机器时间的一致性。

不管你是选择哪个时间，最终的结果就是，调用方通过服务发现，除了可以拿到IP列表，还可以拿到对应的启动时间。

> 我们需要把这个时间作用在负载均衡上，使用基于权重的负载均衡，但是这个权重是由服务提供方设置的，属于一个固定状态。

现在我们要让这个权重变成动态的，并且是随着时间的推移慢慢增加到服务提供方设定的固定值，整个过程如下图所示：

<img src="https://img-blog.csdnimg.cn/3403f44f29144e2493beee4eab0a9348.png" style="zoom:25%;" />

**延迟暴露**

我们应用启动的时候都是通过main入口，然后顺序加载各种相关依赖的类。

以Spring应用启动为例，在加载的过程中，Spring容器会顺序加载Spring Bean，如果某个Bean是RPC服务的话，我们不光要把它注册到SpringBeanFactory里面去，还要把这个Bean对应的接口注册到注册中心。

注册中心在收到新上线的服务提供方地址的时候，会把这个地址推送到调用方应用内存中；当调用方收到这个服务提供方地址的时候，就会去建立连接发请求。

> 但这时候是不是存在服务提供方可能并没有启动完成的情况？

因为服务提供方应用可能还在加载其它的Bean。对于调用方来说，只要获取到了服务提供方的IP，就有可能发起RPC调用，但如果这时候服务提供方没有启动完成的话，就会导致调用失败，从而使业务受损。

**那有什么办法可以避免这种情况吗？**

我们需要利用服务提供方把接口注册到注册中心的那段时间。我们可以在服务提供方应用启动后，接口注册到注册中心前，预留一个Hook过程，让用户可以实现可扩展的Hook逻辑。

用户可以在Hook里面模拟调用逻辑，从而使JVM指令能够预热起来，并且用户也可以在Hook里面事先预加载一些资源，只有等所有的资源都加载完成后，最后才把接口注册到注册中心。整个应用启动过程如下图所示：

![](https://img-blog.csdnimg.cn/63b5ff4fab51495abf8d5c74c48190d9.png)