---
title: 慢查询
categories: 
- Redis开发与运维
---

[慢查询引发的车祸现场，案例分析！](https://mp.weixin.qq.com/s/sL64uQP0iHKxkMFx1QGLkg)

所谓慢查询日志就是系统在命令执行前后计算每条命令的执行时间，当超过预设阀值，就将这条命令的相关信息(例如:发生时间，耗时，命令的详细信息)记录下来，Redis也提供了类似的功能。

Redis客户端执行一条命令分为如下4个部分:

<img src="https://img-blog.csdnimg.cn/62feaad8af1143d09f1a4a49914ed820.png" style="zoom:25%;" />

需要注意，慢查询只统计执行命令的时间，所以没有慢查询并不代表客户端没有超时问题。

**慢查询的两个配置参数**

slowlog-log-slower-than就是那个预设阀值， 它的单位是微秒(1秒=1000毫秒=1000000微秒)，默认值是10000，假如执行了一条很慢的命令(例如`keys*)`，如果它的执行时间超过了10000微秒，那么它将被记录在慢查询日志中。

如果slowlog-log-slower-than=0会记录所有的命令，slowlog-log-slower- than<0对于任何命令都不会进行记录。

slowlog-max-len：说明了慢查询日志最多存储多少条。

**那他存放在哪里?**

实际上Redis使用了一个列表来存储慢查询日志，slowlog-max-len就是列表的最大长度。

一个新的命令满足慢查询条件时 被插入到这个列表中，当慢查询日志列表已处于其最大长度时，最早插入的 一个命令将从列表中移出，例如slowlog-max-len设置为5，当有第6条慢查询插入的话，那么队头的第一条数据就出列，第6条慢查询就会入列。

在Redis中有两种修改配置的方法，一种是修改配置文件，另一种是使用config set命令动态修改。

例如下面使用config set命令将slowlog-log-slower- than设置为20000微秒，slowlog-max-len设置为1000:

```
config set slowlog-log-slower-than 20000 
config set slowlog-max-len 1000
config rewrite
```

如果要Redis将配置持久化到本地配置文件，需要执行config rewrite命令。

通过一组命令来实现对慢查询日志的访问和管理。

```
slowlog get [n]
```

可以看到每个慢查询日志有4个属性组成，分别是慢查询日志的标识 id、发生时间戳、命令耗时、执行命令和参数。

## 最佳实践

**使用过程中要注意以下几点:**

* slowlog-max-len配置：线上建议调大慢查询列表，记录慢查询时 Redis会对长命令做截断操作，并不会占用大量内存，增大慢查询列表可以 减缓慢查询被剔除的可能，例如线上可设置为1000以上。

* slowlog-log-slower-than建议：默认值超过10毫秒判定为慢查询， 需要根据Redis并发量调整该值，由于Redis采用单线程响应命令，对于高流量的场景，如果命令执行时间在1毫秒以上，那么Redis最多可支撑OPS不到 1000，因此对于高QPS场景的Redis建议设置为1毫秒。

慢查询只记录命令执行时间，并不包括命令排队和网络传输时间因此客户端执行命令的时间会大于命令实际执行时间。

由于慢查询日志是一个先进先出的队列，也就是说如果慢查询比较多的情况下，可能会丢失部分慢查询命令，为了防止这种情况发生，可以定期 执行slow get命令将慢查询日志持久化到其他存储中(例如MySQL)，然后 可以制作可视化界面进行查询。