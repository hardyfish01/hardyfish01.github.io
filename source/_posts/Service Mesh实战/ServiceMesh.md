---
title: 基础知识
categories: 
- Service Mesh实战
---

微服务架构尽管它解决了单体服务的很多问题，却也带来了负载均衡、服务治理、服务注册发现、如何拆分服务等问题。

Service Mesh （服务网格）是一个用于处理服务和服务之间通信的基础设施层。

> 通过 sidecar 模式将原本在 SDK 中的代码独立出来，用控制面代替配置中心的部分功能，以透明代理的形式提供安全、快速、可靠的服务间通信，同时也能实现微服务所需的基本组件功能。

实际上，Service Mesh 需要的基础组件和传统的微服务并没有太大的差别，很多公司选择自研控制面的原因，很多就是出于兼容老的微服务的基础组件的考虑，可以把 Service Mesh 看作是**分布式的微服务代理**。

**边车SideCar模式**

边车模式是一种分布式服务架构的设计模式，特别是在各大云服务厂商中应用较多。

> 边车模式因为类似于生活中的边三轮摩托车而得名，也就是侉子摩托车。边三轮摩托车是给摩托车加装一个挎斗，可以装载更多的货物，变得更加多用途，得益于这样的特性，边三轮摩托曾经得到了广泛应用。

在系统设计时，边车模式通过给应用程序添加边车的方式来拓展应用程序现有的功能，分离通用的业务逻辑，比如日志记录、流量控制、服务注册和发现、限流熔断等功能。通过添加边车实现，微服务只需要专注实现业务逻辑即可，实现了控制和逻辑的分离与解耦。

> 边车模式中的边车，实际上就是一个 Agent，微服务的通信可以通过 Agent 代理完成。

在部署时，需要同时启动 Agent，Agent 会处理服务注册、服务发现、日志和服务监控等逻辑。

这样在开发时，就可以忽略这些和对外业务逻辑本身没有关联的功能，实现更好的内聚和解耦。

应用边车模式解耦了服务治理和对外的业务逻辑，这一点和 API 网关比较像，但是边车模式控制的粒度更细，可以直接接管服务实例，合理扩展边车的功能，能够实现服务的横向管理，提升开发效率。

**Service Mesh服务网格**

在边车模式中，可以实现服务注册和发现、限流熔断等功能。

如果边车的功能可以进一步标准化，那么会变得更加通用，就可以抽象出一个通用的服务治理组件，通过边车与其他系统交互，在各个微服务中进行推广。

Service Mesh 基于边车模式演进，通过在系统中添加边车代理，也就是 Sidecar Proxy 实现。

<img src="https://img-blog.csdnimg.cn/32f16e5faa61422e8395bd73000bea18.png" style="zoom:25%;" />

Service Mesh 可以统一管理微服务与上层通信的部分，接管各种网络通信、访问控制等，我们的业务代码只需要关心业务逻辑就可以，简化开发工作。

**Service Mesh 和 API 网关的区别**

服务网格实现的功能和 API 网关类似，都可以以一个切面的形式，进行一些横向功能的实现，比如流量控制、访问控制、日志和监控等功能。

> 服务网格和 API 网关主要的区别是部署方式不同，在整体系统架构中的位置不一样。

* API 网关通常是独立部署，通过单独的系统提供服务，为了实现高可用，还会通过网关集群等来管理；

* 服务网格通常是集成在应用容器内的，服务网格离应用本身更近，相比 API 网关，和应用交互的链路更短，所以可以实现更细粒度的应用管理，也体现了 Sidecar 边车的设计思想。

**Service Mesh 解决方案**

目前两款流行的 Service Mesh 开源软件分别是 Istio 和 Linkerd。

> Istio

Istio 是 Google、IBM 等几大公司联合开源的一个服务网格组件，Istio 提供了负载均衡、服务间的身份验证、监控等方法。

Istio 的实现是通过 Sidecar ，通过添加一个 Sidecar 代理，在环境中为服务添加 Istio 的支持。

Istio 代理会拦截不同服务之间的通信，然后进行统一的配置和管理。

> Istio + Envoy

Istio 包含控制面 Istiod 和数据面 Envoy 两个组件。

* Istiod 是 Istio 的控制面，负责配置校验和下发、证书轮转等工作；
* Envoy 则负责数据代理和流量路由等工作。 
* Istio + Envoy 组成整个 Service Mesh 体系

> Linkerd

Linkerd 最早由 Twitter 贡献，支持的功能和 Istio 类似，Linkerd 是一款开源网络代理，可以作为服务网格进行部署，在应用程序内管理和控制服务与服务之间的通信。

**Service Mesh 常见名词**

> 数据面(Data Plane)

负责数据的转发，一般我们常见的通用网关、Web Server，比如 Nginx、Traefik 都可以认为是数据面的一种。

在 Service Mesh 的开源世界中，Envoy 可以说是最知名的数据面了。

> 控制面(Control Plane)

通过对数据面进行配置下发，以控制数据面的行为，比如路由转发、负载均衡、服务治理等配置下发。

**Service Mesh 的基础组件**

* 服务注册中心：服务间通信的基础组件。服务通过注册自身节点，让调用方服务发现被调方服务节点，以达到服务间点对点通信的目的。

* 配置中心：用于服务的基础配置更新，以达到代码和配置分离的目的。减少服务的发布次数，配置发布可以更快更及时地变更服务。

* API 网关：通过统一的网关层，收敛服务的统一鉴权层、链路 ID 生成等基础服务，并聚合后端服务为客户端提供 RESTful 接口。另外 API 网关也负责南北向流量(外网入口流量)的流量治理。

* 服务治理：通过限流、熔断等基础组件，杜绝微服务架构出现雪崩的隐患。

* 链路追踪：通过 trace 将整个微服务链路清晰地绘制出来，并进行精准的故障排查，极大地降低了故障排查的难度。

* 监控告警：通过 Prometheus 和 Grafana 这样的基础组件，绘制服务状态监控大盘，针对资源、服务、业务各项指标，做精准的监控报警。

**注册中心实现**

**Service Mesh 中实现的注册发现功能，相比传统微服务有哪些优势呢？**

1. 无须服务自身注册，由 sidecar 代理注册

sidecar 通过接受控制面下发的配置信息，进行服务注册。

2. 通过控制面聚合多种、多个注册中心数据

3. 通过 sidecar 提供服务正确性 check 功能

在注册中心中，有一种健康检查方式是注册中心主动 ping 服务的模式。

实际上如果服务 IP 发生变化，又用了同样的 ping 接口时，健康检查会出现错误。

通过 sidecar 模式，当发现服务 ping 接口过来的流量时，进行服务名称的检测，通过 header 中增加服务名称与本地服务名称做校验的方式进行检测，可以有效避免这样的错误。

**中间件Mesh化**

著名的数据面已经支持了诸多数据库和队列中间件，例如 MySQL、MongoDB、PostgreSQL、Redis、Kafka 等。

**Redis 代理**

Envoy 可以作为 Redis 的代理，部署在每个服务的节点上，这样就无须传统的 Redis 中间件负责 Redis 集群的代理工作，也不需要传统 Redis 官方提供的 Smart Client。

* Envoy 可以替代这部分功能，控制 Redis 集群，路由到正确的 hash 分片节点上。

* 使用 Envoy 做 Redis 代理，既避免了传统的 Smart Client 的升级维护问题，也避免了传统的 Redis 中间件中心化的问题。

通过 Mesh 的架构、Metrics 注入等方式，可以看到到底是哪个服务调用的 Redis，再配合服务间的链路调用图，这样整个内网间所有流量的链路调用图就可以绘制出来了。
