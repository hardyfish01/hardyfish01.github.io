---
title: 索引
categories: 
- 数据库
- MySQL
---

索引是帮助MySQL高效获取数据的数据结构，简单理解为：排好序的快速查找数据结构。

**索引分类**

按结构分：

- Hash索引和B+树索引

根据索引字段个数划分：

- 单值和复合索引

根据是否是在主键上建立的索引进行划分：

- 主键索引，辅助索引

根据数据与索引的存储关联性划分：

- 聚簇索引/非聚簇索引

其他分类：唯一索引，全文索引

**聚簇索引/非聚簇索引**

- 聚簇索引：Innodb的主键索引，非叶子节点存储的是索引指针，叶子节点存储的是既有索引也有数据
- 非聚簇索引：MyISAM中索引和数据文件分开存储，B+Tree的叶子节点存储的是数据存放的地址，而不是具体的数据

**二级索引**

针对`select * from table where name='xx'`这样的语句，你先根据name字段值在name字段的索引B+树里找，找到叶子节点也仅仅可以找到对应的主键值，而找不到这行数据完整的所有字段。

此时还需要进行回表，这个回表，就是说还需要根据主键值，再到聚簇索引里从根节点开始，一路找到叶子节点的数据页，定位到主键对应的完整数据行，此时才能把`select *`要的全部字段值都拿出来。

**索引结构**

MySQL使用B+树作为索引结构

<img src="https://img-blog.csdnimg.cn/fe2bdc29aaa645ee8839cce481d5db84.png" alt="img" style="zoom:25%;" />

**B+树索引的特点是：**

- 基于磁盘的平衡树，但树非常矮，通常为 3~4 层，能存放千万到上亿的排序数据。
- 树矮意味着访问效率高，从千万或上亿数据里查询一条数据，只用 3、4 次 I/O。

如果我们使用的是MyISAM存储引擎，由于MyISAM使用的是辅助索引，索引中每一个叶子节点仅仅记录的是每行数据的物理地址，即行指针，如下图所示：

<img src="https://img-blog.csdnimg.cn/f72e085fc82b4c79b640d70c2c35849d.png" alt="img" style="zoom:25%;" />

如果我们使用的是InnoDB存储引擎，由于InnoDB使用的是聚簇索引，聚簇索引中的叶子节点则记录了主键值、事务id、用于事务和MVCC的回流指针以及所有的剩余列，如下图所示：

<img src="https://img-blog.csdnimg.cn/ed85ca4e31b841eb9995038e4feea95f.png" alt="img" style="zoom:25%;" />

**B+树比B树更适合数据库索引的原因**

- B+树的查询效率更加稳定，任何关键字的查找必须走一条从根结点到叶子结点，所有关键字查询的路径长度相同，导致每一个数据的查询效率相当。
- 由于非叶子节点不存储 data，所以一个节点可以存储更多的索引节点，每个节点能索引的范围更大更精确，也就是说使用 B+树单次磁盘 I/O 的信息量相比较 B 树更大，I/O 效率更高 。
- B+树只要遍历叶子节点就可以实现整棵树的遍历，支持基于范围的查询。

**覆盖索引**

针对类似`select xx1,xx2,xx3 from table order by xx1,xx2,xx3`这样的语句，这种情况下，你仅仅需要联合索引里的几个字段的值，那么其实就只要扫描联合索引的索引树就可以了，不需要 回表 去聚簇索引里找其他字段了。

- 所以这个时候，需要的字段值直接在索引树里就能提取出来，不需要回表到聚簇索引，这种查询方式就是覆盖索引。

**索引失效**

> 最佳左前缀法则

- 如果索引了多个列，要遵守最佳左前缀法则。指的是查询从索引的最左前列开始 并且 不跳过索引中的列

> 不要在索引上做任何操作（计算、函数、自动/手动类型转换），不然会导致索引失效而转向全表扫描

```sql
select * from tradelog where id + 1 = 10000
//where id = 10000 -1
```

- 不能继续使用索引中范围条件（`bettween、<、>、in`等）右边的列 。
- 尽量使用覆盖索引（只查询索引的列（索引列和查询列一致）），减少`select *` 。
- 索引字段上使用（`！= 或者 < >`）判断时，会导致索引失效而转向全表扫描。
- 索引字段上使用 `is null / is not null` 判断时，会导致索引失效而转向全表扫描。
- 索引字段使用like以通配符开头（`%字符串`）时，会导致索引失效而转向全表扫描。
- 索引字段是字符串，但查询时不加单引号，会导致索引失效而转向全表扫描。
- 索引字段使用 or 时，会导致索引失效而转向全表扫描。

> 隐式字符编码转换

如果两个表的字符集不同，一个是utf8，一个是utf8mb4，做表连接查询的时候就用不上关联字段的索引。

字符集utf8mb4是utf8的超集，当这两个类型的字符串在做比较的时候，MySQL内部的操作是，先把utf8字符串转成utf8mb4字符集，再做比较。