---
title: 主从复制
categories: 
- 高性能MySQL
---

**基本原理**

* 主库将变更写入 `binlog` 日志，从库连接到主库之后，主库会创建一个`log dump` 线程，用于发送 `bin log` 的内容。

* 从库开启同步以后，会创建一个 IO 线程用来连接主库，请求主库中更新的 `bin log`，I/O 线程接收到主库 `binlog dump` 进程发来的更新之后，保存在本地 `relay` 日志中。

* 从库中有一个 SQL 线程负责读取 `relay log` 中的内容，同步到数据库存储中，也就是在自己本地进行回放，最终保证主从数据的一致性。

![](https://img-blog.csdnimg.cn/fa709c40685e4aa695e266a37e974da7.png)

**MySQL数据库主从复制有异步复制、半同步复制和全同步复制的方式**

> 异步复制

异步复制模式下，主库在接受并处理客户端的写入请求时，直接返回执行结果，不关心从库同步是否成功，这样主库崩溃以后，可能有部分操作没有同步到从库，出现数据丢失问题。

> 半同步复制

在半同步复制模式下，主库需要等待至少一个从库完成同步之后，才完成写操作。主库在执行完客户端提交的事务后，从库将日志写入自己本地的 `relay log` 之后，会返回一个响应结果给主库，主库确认从库已经同步完成，才会结束本次写操作。

半同步复制要求 Master 事务提交过程中，至少有 N 个 Slave 接收到二进制日志，这样就能保证当 Master 发生宕机，至少有 N 台 Slave 服务器中的数据是完整的。

半同步复制并不是 MySQL 内置的功能，而是要安装半同步插件，并启用半同步复制功能，设置 N 个 Slave 接受二进制日志成功

> 全同步复制

全同步复制指的是在多从库的情况下，当主库执行完一个事务，需要等待所有的从库都同步完成以后，才完成本次写操作。全同步复制需要等待所有从库执行完对应的事务，所以整体性能是最差的。

> 多源复制

无论是异步复制还是半同步复制，都是 1 个 Master 对应 N 个 Slave。其实 MySQL 也支持 N 个 Master 对应 1 个 Slave，这种架构就称之为多源复制。

多源复制允许在不同 MySQL 实例上的数据同步到 1 台 MySQL 实例上，方便在 1 台 Slave 服务器上进行一些统计查询，如常见的 OLAP 业务查询。

> 延迟复制

Slave 在接收二进制日志后会尽可能快地回放日志，这样是为了避免主从之间出现延迟。

而延迟复制却允许Slave 延迟回放接收到的二进制日志，为了避免主服务器上的误操作，马上又同步到了从服务器，导致数据完全丢失。

**主从延时**

[关于主从延迟，一篇文章给你讲明白了！](https://mp.weixin.qq.com/s/dVDxnvBhKm_hVuRlBiecuQ)

**读写分离**

互联网大部分业务场景都是读多写少的，对于电商等典型业务，读和写的请求对比可能差了不止一个数量级。

> 为了不让数据库的读成为业务瓶颈，同时也为了保证写库的成功率，一般会采用读写分离的技术来保证。

读写分离的实现是把访问的压力从主库转移到从库，特别在单机数据库无法支撑并发读写，并且业务请求大部分为读操作的情况下。

如果业务特点是写多读少，比如一些需要动态更新的业务场景，应用读写分离就不合适了，由于 MySQL InnoDB 等关系型数据库对事务的支持，使得写性能不会太高，一般会选择更高性能的 NoSQL 等存储来实现。

**读写分离是基于主从复制架构实现的**