---
title: 整数集合
categories: 
- Redis设计与实现
---

整数集合(intset)是集合键的底层实现之一，当一个集合**只包含整数值元素**，并且这个集合的元素**数量不多**时，Redis 就会使用整数集合作为集合键的底层实现。

```c
127.0.0.1:6379> SADD numbers 1 2 3 4 5 6 7 8 9 10
(integer) 10
127.0.0.1:6379> OBJECT ENCODING numbers
"intset"
```

**整数集合的数据结构**

```c
typedef struct intset {
    // 编码方式
    uint32_t encoding;
    
    // 集合包含的元素数量
    unint32_t length;
    
    // 保存元素的数组
    int8_t contents[];
} intset;
```

`intset` 是 `Redis` 用于保存整数值的集合抽象数据结构，它可以保存 `int16_t`、`int32_t` 或者 `int64_t` 的整数值，并且保证集合中不会出现重复元素。

- `encoding`：表示集合保存的整数值是什么类型的；
- `length`：记录了整数集合中包含的元素数量，也就是 `contents` 数组的长度；
- `contents`：将整数集合中的元素从小到大地排序存放在 `contents` 数组中，并且不包含重复元素。`contents` 数组的真正存储类型取决于 `encoding` 的值。

整数集合示例如下：

![](https://img-blog.csdnimg.cn/27e2ec18752745e4b9f596fa0858496a.png)

**升级**

当往一个 `encoding = int16_t` 的数组中添加一个 `int64_t` 类型的值时，整数集合会先进行升级，然后再将元素添加至整数集合中。

具体步骤如下：

1. 根据新元素的类型，扩展整数集合底层数组的空间大小，并为新元素分配空间；
2. 将底层数组现有的所有元素都转换成新元素相同的类型，并将类型转换后的元素放置到正确的位置上，并且保持从小到大的顺序不变；
3. 将新元素添加到数组中。

由于每次向整数集合添加新元素都**可能会引起升级**，而每次升级都需要对底层数组中已有元素进行类型转换，所以添加的时间复杂度为O(N)。

**升级的好处**

> 提升整数集合的灵活度

一般存储数据时，都是使用具体的数据类型存储相对应的元素，`int16_t 类型 -> int64_t 元素`。

通过**整数集合的升级**，可以随意的将 `int16_t`、`int32_t` 和 `int64_t` 类型的元素添加到一个集合中，且不需要担心类型出错的问题。

> 节约内存

只有当数组中的元素类型是 `int32_t/int64_t` 时，才会进行升级，扩展内存空间，不会出现当数组中所有的元素是 `int16_t` 类型时，数组底层类型是 `int64_t` 的情况。

**降级**

整数集合不支持降级操作，一旦对数组进行了升级，编码就会一直保持升级后的状态。

**整数集合的时间复杂度**

整数集合相关操作及时间复杂度：

![](https://img-blog.csdnimg.cn/e9ccf1977b5b49b79f7910281cd413e2.png)