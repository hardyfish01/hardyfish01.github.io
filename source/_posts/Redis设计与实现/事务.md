---
title: 事务
categories: 
- Redis设计与实现
---

Redis通过`MULTI`，`EXEC`，`WATCH`等命令实现事务功能。

* 事务是将**多个命令打包**，然后**原子地按顺序地执行**的机制，执行期间服务器**不会中断事务**执行其他客户端的命令请求。

下面展示了一次完整事务的执行命令：

```
redis> MULTI
OK
redis> SET "name" "The Design and Implementation of Redis"
QUEUED
redis> GET "name"
QUEUED
redis> EXEC
1) OK
2) "The Design and Implementation of Redis"
```

**事务的实现**

事务主要有3个阶段：事务开始、命令入队、事务执行。

**事务开始**

MULTI命令表示事务的开始，将客户端从非事务状态切换为事务状态。

**命令入队**

当客户端处于事务状态时，命令不会被立即执行（除了EXEC、DISCARD、WATCH、MULTI），而是加入事务队列。

**执行事务**

当收到客户端的EXEC命令时，将被立即执行，然后服务器遍历客户端的事务队列，保存命令，执行命令给，返回结果给客户端，移除事务标识。

**WATCH命令的实现**

WATCH命令是一个**乐观锁**，可以在EXEC前**监视任意数量的键**，如果在EXEC执行时，键被修改过，服务器将拒绝执行事务。

**事务的ACID性质**

Redis的事务有原子性、一致性和隔离性，当Redis运行在特定的持久化模式下时，才具有持久性。

**原子性**

Redis事务队列中的命令，要么全部都执行，要么一个都不执行，因此，具有原子性。

Redis进行事务命令入队时，如果命令入队出错，会被拒绝执行。

* 但是命令的语法错误（执行错误），不会导致整个命令不被执行，也就是说Redis不支持事务的回滚机制。

不支持事务回滚是考虑到了复杂性，与其**简单高效的理念不符**，并且Redis的设计者认为，Redis事务的执行时错误通常都是**编程错误**产生的，在开发环境中会有，但生产环境不应该出现，因此，没有设计回滚机制。

**一致性**

一致性表示在事务的执行前后，成功与否，数据库**都是一致的**，也就是数据符合数据库本身定义和要求，**没有非法或无效错误数据**。

Redis通过简单的错误检测来保证一致性。

> 入队错误

在2.6.5之后的版本，如果一个事务在入队时出现了命令不存在，Redis则拒绝执行这个事务。

> 执行错误

对于命令执行期间发现的错误，**不会影响其他命令**的执行。服务器会识别出错的命令，并进行相应处理，这些命令不会对数据库做修改，不影响一致性。

> 服务器停机

如果Redis在执行过程中停机，数据也是一致的。

* 如果没有开启持久化，重启后数据库是空白的。

* 开启持久化后，重启后会还原到一致状态。

**隔离性**

Redis是单线程的，并且服务器保证在执行事务期间**不会对事务进行中断**，因此是具有隔离性的。

并且队列中的命令没有提交之前都不会实际的被执行，因为事务提交前任何指令都不会被实际执行，因此**没有隔离级别概念**。

**持久性**

持久性的意思是，事务执行的结果被**永久性地保存**，执行事务的结果不会丢失。

因为Redis没有单独为事务队列提供持久化功能，所以**取决于持久化模式**，只有AOF方式持久化并且appendsync的值为always，因为其他方式并不能保证事务的执行结果被第一时间保存到硬盘里。