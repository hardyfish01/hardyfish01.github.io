---
title: 领域事件
categories: 
- 实现领域驱动设计
---

在事件风暴（Event Storming）时，我们发现除了命令和操作等业务行为以外，还有一种非常重要的事件，这种事件发生后通常会导致进一步的业务操作，在DDD中这种事件被称为领域事件。

领域事件是领域模型中非常重要的一部分，用来表示领域中发生的事件。一个领域事件将导致进一步的业务操作，在实现业务解耦的同时，还有助于形成完整的业务闭环。

举例来说的话，领域事件可以是业务流程的一个步骤

* 比如投保业务缴费完成后，触发投保单转保单的动作；

* 也可能是定时批处理过程中发生的事件，比如批处理生成季缴保费通知单，触发发送缴费邮件通知操作；

* 或者一个事件发生后触发的后续动作，比如密码连续输错三次，触发锁定账户的动作。

**如何识别领域事件呢？**

在做用户旅程或者场景分析时，我们要捕捉业务、需求人员或领域专家口中的关键词：

* 如果发生……，则……，当做完……的时候，请通知……，发生……时，则……等。

在这些场景中，如果发生某种事件后，会触发进一步的操作，那么这个事件很可能就是领域事件。

> 那领域事件为什么要用最终一致性，而不是传统SOA的直接调用的方式呢？

**聚合的一个设计原则：**

* 在边界之外使用最终一致性。

* 一次事务最多只能更改一个聚合的状态。

* 如果一次业务操作涉及多个聚合状态的更改，应采用领域事件的最终一致性。

领域事件驱动设计可以切断领域模型之间的强依赖关系，事件发布完成后，发布方不必关心后续订阅方事件处理是否成功，这样可以实现领域模型的解耦，维护领域模型的独立性和数据的一致性。

在领域模型映射到微服务系统架构时，领域事件可以解耦微服务，微服务之间的数据不必要求强一致性，而是基于事件的最终一致性。

**微服务内的领域事件**

当领域事件发生在微服务内的聚合之间，领域事件发生后完成事件实体构建和事件数据持久化，发布方聚合将事件发布到事件总线，订阅方接收事件数据完成后续业务操作。

微服务内大部分事件的集成，都发生在同一个进程内，进程自身可以很好地控制事务，因此不一定需要引入消息中间件。

* 但一个事件如果同时更新多个聚合，按照DDD**一次事务只更新一个聚合**的原则，你就要考虑是否引入事件总线。

* 但微服务内的事件总线，可能会增加开发的复杂度，因此你需要结合应用复杂度和收益进行综合考虑。

微服务内应用服务，可以通过跨聚合的服务编排和组合，以服务调用的方式完成跨聚合的访问，这种方式通常应用于实时性和数据一致性要求高的场景。这个过程会用到**分布式事务**，以保证发布方和订阅方的数据同时更新成功。

**微服务之间的领域事件**

跨微服务的领域事件会在不同的限界上下文或领域模型之间实现业务协作，其主要目的是实现微服务解耦，减轻微服务之间实时服务访问的压力。

领域事件发生在微服务之间的场景比较多，事件处理的机制也更加复杂。跨微服务的事件可以推动业务流程或者数据在不同的子域或微服务间直接流转。

跨微服务的事件机制要总体考虑事件构建、发布和订阅、事件数据持久化、消息中间件，甚至事件数据持久化时还可能需要考虑引入分布式事务机制等。

微服务之间的访问也可以采用应用服务直接调用的方式，实现数据和服务的实时访问，弊端就是跨微服务的数据同时变更需要引入分布式事务，以确保数据的一致性。分布式事务机制会影响系统性能，增加微服务之间的耦合，所以我们还是要尽量避免使用分布式事务。

**领域事件总体架构**

领域事件的执行需要一系列的组件和技术来支撑。

领域事件总体技术架构图，领域事件处理包括：事件构建和发布、事件数据持久化、事件总线、消息中间件、事件接收和处理等。

<img src="https://img-blog.csdnimg.cn/3170ec278bf94e0e8afc348a5122e64f.png" style="zoom:25%;" />

> 事件构建和发布

事件基本属性至少包括：事件唯一标识、发生时间、事件类型和事件源，其中事件唯一标识应该是全局唯一的，以便事件能够无歧义地在多个限界上下文中传递。事件基本属性主要记录事件自身以及事件发生背景的数据。

另外事件中还有一项更重要，那就是业务属性，用于记录事件发生那一刻的业务数据，这些数据会随事件传输到订阅方，以开展下一步的业务操作。

事件基本属性和业务属性一起构成事件实体，事件实体依赖聚合根。领域事件发生后，事件中的业务数据不再修改，因此业务数据可以以序列化值对象的形式保存，这种存储格式在消息中间件中也比较容易解析和获取。

事件发布之前需要先构建事件实体并持久化。事件发布的方式有很多种，你可以通过应用服务或者领域服务发布到事件总线或者消息中间件，也可以从事件表中利用定时程序或数据库日志捕获技术获取增量事件数据，发布到消息中间件。

> 事件数据持久化

事件数据持久化可用于系统之间的数据对账，或者实现发布方和订阅方事件数据的审计。

当遇到消息中间件、订阅方系统宕机或者网络中断，在问题解决后仍可继续后续业务流转，保证数据的一致性。

事件数据持久化有两种方案，在实施过程中你可以根据自己的业务场景进行选择。

- 持久化到本地业务数据库的事件表中，利用本地事务保证业务和事件数据的一致性。
- 持久化到共享的事件数据库中。这里需要注意的是：业务数据库和事件数据库不在一个数据库中，它们的数据持久化操作会跨数据库，因此需要分布式事务机制来保证业务和事件数据的强一致性，结果就是会对系统性能造成一定的影响。

> 事件总线(EventBus)

事件总线是实现微服务内聚合之间领域事件的重要组件，它提供**事件分发和接收**等服务。

事件总线是进程内模型，它会在微服务内聚合之间遍历订阅者列表，采取同步或异步的模式传递数据。

事件分发流程大致如下：

- 如果是微服务内的订阅者（其它聚合），则直接分发到指定订阅者；
- 如果是微服务外的订阅者，将事件数据保存到事件库（表）并异步发送到消息中间件；
- 如果同时存在微服务内和外订阅者，则先分发到内部订阅者，将事件消息保存到事件库（表），再异步发送到消息中间件。

> 消息中间件

跨微服务的领域事件大多会用到消息中间件，实现跨微服务的事件发布和订阅。

消息中间件的产品非常成熟，市场上可选的技术也非常多，比如Kafka，RabbitMQ等。

> 事件接收和处理

微服务订阅方在应用层采用监听机制，接收消息队列中的事件数据，完成事件数据的持久化后，就可以开始进一步的业务处理。

领域事件处理可在领域服务中实现。

**领域事件运行机制相关案例**

这里我用承保业务流程的缴费通知单事件，来给你解释一下领域事件的运行机制。

这个领域事件发生在投保和收款微服务之间。发生的领域事件是：

* 缴费通知单已生成。

* 下一步的业务操作是：缴费。

<img src="https://img-blog.csdnimg.cn/d550d8a2b2534293987d787504310cd9.png" style="zoom:25%;" />

**事件起点：出单员生成投保单，核保通过后，发起生成缴费通知单的操作。**

1. 投保微服务应用服务，调用聚合中的领域服务createPaymentNotice和createPaymentNoticeEvent，分别创建缴费通知单、缴费通知单事件。其中缴费通知单事件类PaymentNoticeEvent继承基类DomainEvent。

2. 利用仓储服务持久化缴费通知单相关的业务和事件数据。
3. 为了避免分布式事务，这些业务和事件数据都持久化到本地投保微服务数据库中。
4. 通过数据库日志捕获技术或者定时程序，从数据库事件表中获取事件增量数据，发布到消息中间件（**这里说明：事件发布也可以通过应用服务或者领域服务完成发布**）。
5. 收款微服务在应用层从消息中间件订阅缴费通知单事件消息主题，监听并获取事件数据后，应用服务调用领域层的领域服务将事件数据持久化到本地数据库中。
6. 收款微服务调用领域层的领域服务PayPremium，完成缴费。
7. 事件结束。

# 事件风暴

事件风暴是一项团队活动，领域专家与项目团队通过头脑风暴的形式，罗列出领域中所有的领域事件，整合之后形成最终的领域事件集合，然后对每一个事件，标注出导致该事件的命令，再为每一个事件标注出命令发起方的角色。

命令可以是用户发起，也可以是第三方系统调用或者定时器触发等，最后对事件进行分类，整理出实体、聚合、聚合根以及限界上下文。

而事件风暴正是DDD战略设计中经常使用的一种方法，它可以快速分析和分解复杂的业务领域，完成领域建模。

**下面我带你看一张图，这张图描述了从事件风暴建立通用语言到领域对象设计和代码落地的完整过程。**

<img src="https://img-blog.csdnimg.cn/ba5160554f3743a2a63ac2181ddd07f7.png" style="zoom:25%;" />

1. 在事件风暴的过程中，领域专家会和设计、开发人员一起建立领域模型，在领域建模的过程中会形成通用的业务术语和用户故事。事件风暴也是一个项目团队统一语言的过程。
2. 通过用户故事分析会形成一个个的领域对象，这些领域对象对应领域模型的业务对象，每一个业务对象和领域对象都有通用的名词术语，并且一一映射。
3. 微服务代码模型来源于领域模型，每个代码模型的代码对象跟领域对象一一对应。

**分享一条经验，特别有效。**

设计过程中我们可以用一些表格，来记录事件风暴和微服务设计过程中产生的领域对象及其属性。

比如，领域对象在DDD分层架构中的位置、属性、依赖关系以及与代码模型对象的映射关系等。

下面是一个微服务设计实例的部分数据，表格中的这些名词术语就是项目团队在事件风暴过程中达成一致、可用于团队内部交流的通用语言。

在这个表格里面我们可以看到，DDD分析过程中所有的领域对象以及它们的属性都被记录下来了，除了DDD的领域对象，我们还记录了在微服务设计过程中领域对象所对应的代码对象，并将它们一一映射。

<img src="https://img-blog.csdnimg.cn/1896ab5e28434446bc96143d73353f97.png" style="zoom:25%;" />